
tod_manager_inactive = 0
tod_manager_num_prefixes = 10
tod_manager_levels_using_new_system = {
    load_bo = 1
    load_ba = 1
    load_be = 1
    load_au = 1
    load_NO = 1
}
tod_manager_default_morning = {
    state_length = 90000
    sun_theta = 0.0
    sun_phi = -10.0
    sun_red = 255.0
    sun_green = 210.0
    sun_blue = 172.0
    lev_red = 64
    lev_green = 77
    lev_blue = 81
    sky_red = 128
    sky_green = 128
    sky_blue = 128
    fog_on = 1
    fog_red = 85
    fog_green = 100
    fog_blue = 105
    fog_alpha = 108
    fog_dist = 2500
    ambient_red = 41
    ambient_green = 42
    ambient_blue = 45
    ambient_mod_factor_lo = 0.1800
    ambient_mod_factor_hi = 0.0
    heading_0 = 188
    pitch_0 = 351
    red_0 = 16
    green_0 = 19
    blue_0 = 29
    mod_factor_0_lo = 0.1200
    mod_factor_0_hi = 0.0
    heading_1 = 0
    pitch_1 = 0
    red_1 = 34
    green_1 = 42
    blue_1 = 49
    mod_factor_1_lo = 0.1000
    mod_factor_1_hi = 0.0
    headlights_on = 0
    bloom_on = 1
    bloom_color = [ 150 100 200 ]
    bloom1 = 30
    bloom2 = 100
    bloom_strength = [ 48 64 76 ]
    entry_script = NullScript
}
tod_manager_default_morning_sky = {
    state_length = 110000
    sun_theta = 0.0
    sun_phi = -10.0
    sun_red = 255.0
    sun_green = 255.0
    sun_blue = 255.0
    lev_red = 64
    lev_green = 77
    lev_blue = 81
    sky_red = 128
    sky_green = 128
    sky_blue = 128
    fog_on = 1
    fog_red = 85
    fog_green = 100
    fog_blue = 105
    fog_alpha = 108
    fog_dist = 2500
    ambient_red = 41
    ambient_green = 42
    ambient_blue = 45
    ambient_mod_factor_lo = 0.1800
    ambient_mod_factor_hi = 0.0
    heading_0 = 188
    pitch_0 = 351
    red_0 = 16
    green_0 = 19
    blue_0 = 29
    mod_factor_0_lo = 0.1200
    mod_factor_0_hi = 0.0
    heading_1 = 0
    pitch_1 = 0
    red_1 = 34
    green_1 = 42
    blue_1 = 49
    mod_factor_1_lo = 0.1000
    mod_factor_1_hi = 0.0
    headlights_on = 0
    entry_script = NullScript
}
tod_manager_default_afternoon = {
    state_length = 400000
    sun_theta = 0.0
    sun_phi = 20.0
    sun_red = 255.0
    sun_green = 255.0
    sun_blue = 255.0
    lev_red = 128
    lev_green = 128
    lev_blue = 128
    sky_red = 128
    sky_green = 128
    sky_blue = 128
    fog_red = 128
    fog_green = 128
    fog_blue = 128
    fog_alpha = 0
    fog_dist = 200000
    ambient_red = 50
    ambient_green = 50
    ambient_blue = 50
    ambient_mod_factor_lo = 0.3000
    ambient_mod_factor_hi = 0.0
    heading_0 = 60
    pitch_0 = 330
    red_0 = 136
    green_0 = 120
    blue_0 = 110
    mod_factor_0_lo = 0.7500
    mod_factor_0_hi = 0.0
    heading_1 = 245
    pitch_1 = 330
    red_1 = 72
    green_1 = 70
    blue_1 = 66
    mod_factor_1_lo = 0.7500
    mod_factor_1_hi = 0.0
    headlights_on = 0
    bloom_on = 1
    bloom_color = [ 120 120 120 ]
    bloom1 = 20
    bloom2 = 80
    bloom_strength = [ 35 35 35 ]
    entry_script = NullScript
}
tod_manager_default_afternoon_sky = {
    state_length = 400000
    sun_theta = 0.0
    sun_phi = 20.0
    sun_red = 255.0
    sun_green = 255.0
    sun_blue = 255.0
    lev_red = 128
    lev_green = 128
    lev_blue = 128
    sky_red = 128
    sky_green = 128
    sky_blue = 128
    fog_red = 128
    fog_green = 128
    fog_blue = 128
    fog_alpha = 0
    fog_dist = 200000
    ambient_red = 50
    ambient_green = 50
    ambient_blue = 50
    ambient_mod_factor_lo = 0.3000
    ambient_mod_factor_hi = 0.0
    heading_0 = 60
    pitch_0 = 330
    red_0 = 136
    green_0 = 120
    blue_0 = 110
    mod_factor_0_lo = 0.7500
    mod_factor_0_hi = 0.0
    heading_1 = 245
    pitch_1 = 330
    red_1 = 72
    green_1 = 70
    blue_1 = 66
    mod_factor_1_lo = 0.7500
    mod_factor_1_hi = 0.0
    headlights_on = 0
    entry_script = NullScript
}
tod_manager_default_evening = {
    state_length = 90000
    sun_theta = 0.0
    sun_phi = 180.0
    sun_red = 255.0
    sun_green = 128
    sun_blue = 64
    lev_red = 100
    lev_green = 95
    lev_blue = 74
    sky_red = 76
    sky_green = 66
    sky_blue = 50
    fog_red = 100
    fog_green = 86
    fog_blue = 29
    fog_alpha = 30
    fog_dist = 5000
    ambient_red = 39
    ambient_green = 38
    ambient_blue = 32
    ambient_mod_factor_lo = 0.3000
    ambient_mod_factor_hi = 0.0
    heading_0 = 50
    pitch_0 = 330
    red_0 = 104
    green_0 = 101
    blue_0 = 60
    mod_factor_0_lo = 0.7500
    mod_factor_0_hi = 0.0
    heading_1 = 240
    pitch_1 = 330
    red_1 = 45
    green_1 = 42
    blue_1 = 38
    mod_factor_1_lo = 0.4000
    mod_factor_1_hi = 0.0
    headlights_on = 0
    bloom_on = 1
    bloom_color = [ 120 120 120 ]
    bloom1 = 20
    bloom2 = 80
    bloom_strength = [ 35 35 35 ]
    entry_script = NullScript
}
tod_manager_default_evening_sky = {
    state_length = 110000
    sun_theta = 0.0
    sun_phi = 180.0
    sun_red = 0.0
    sun_green = 0.0
    sun_blue = 0.0
    lev_red = 100
    lev_green = 95
    lev_blue = 74
    sky_red = 76
    sky_green = 66
    sky_blue = 50
    fog_red = 100
    fog_green = 86
    fog_blue = 29
    fog_alpha = 30
    fog_dist = 5000
    ambient_red = 39
    ambient_green = 38
    ambient_blue = 32
    ambient_mod_factor_lo = 0.3000
    ambient_mod_factor_hi = 0.0
    heading_0 = 50
    pitch_0 = 330
    red_0 = 104
    green_0 = 101
    blue_0 = 60
    mod_factor_0_lo = 0.7500
    mod_factor_0_hi = 0.0
    heading_1 = 240
    pitch_1 = 330
    red_1 = 45
    green_1 = 42
    blue_1 = 38
    mod_factor_1_lo = 0.4000
    mod_factor_1_hi = 0.0
    headlights_on = 0
    entry_script = NullScript
}
tod_manager_default_night = {
    state_length = 140000
    sun_theta = 0.0
    sun_phi = 200.0
    sun_red = 0.0
    sun_green = 0.0
    sun_blue = 0.0
    lev_red = 50
    lev_green = 65
    lev_blue = 75
    sky_red = 18
    sky_green = 22
    sky_blue = 24
    fog_red = 5
    fog_green = 16
    fog_blue = 22
    fog_alpha = 63
    fog_dist = 8000
    ambient_red = 26
    ambient_green = 36
    ambient_blue = 40
    ambient_mod_factor_lo = 0.3000
    ambient_mod_factor_hi = 0.0
    heading_0 = 330
    pitch_0 = 330
    red_0 = 70
    green_0 = 100
    blue_0 = 106
    mod_factor_0_lo = 0.8000
    mod_factor_0_hi = 0.8000
    heading_1 = 151
    pitch_1 = 330
    red_1 = 15
    green_1 = 30
    blue_1 = 30
    mod_factor_1_lo = 0.1000
    mod_factor_1_hi = 0.0
    headlights_on = 1
    bloom_on = 1
    bloom_color = [ 150 100 200 ]
    bloom1 = 30
    bloom2 = 100
    bloom_strength = [ 48 64 76 ]
    entry_script = NullScript
}
tod_manager_default_night_sky = {
    state_length = 100000
    sun_theta = 0.0
    sun_phi = 200.0
    sun_red = 255.0
    sun_green = 255.0
    sun_blue = 255.0
    lev_red = 50
    lev_green = 65
    lev_blue = 75
    sky_red = 18
    sky_green = 22
    sky_blue = 24
    fog_red = 5
    fog_green = 16
    fog_blue = 22
    fog_alpha = 63
    fog_dist = 8000
    ambient_red = 26
    ambient_green = 36
    ambient_blue = 40
    ambient_mod_factor_lo = 0.3000
    ambient_mod_factor_hi = 0.0
    heading_0 = 330
    pitch_0 = 330
    red_0 = 70
    green_0 = 100
    blue_0 = 106
    mod_factor_0_lo = 0.8000
    mod_factor_0_hi = 0.8000
    heading_1 = 151
    pitch_1 = 330
    red_1 = 15
    green_1 = 30
    blue_1 = 30
    mod_factor_1_lo = 0.1000
    mod_factor_1_hi = 0.0
    headlights_on = 1
    entry_script = NullScript
}
tod_morning_light_prefixes = [ 
'TRG_Morning_LevelLight'
 ]
tod_afternoon_light_prefixes = [ 
'TRG_Afternoon_LevelLight'
 ]
tod_evening_light_prefixes = [ 
'TRG_Evening_LevelLight'
 ]
tod_night_light_prefixes = [ 
'TRG_Night_LevelLight'
 ]

script tod_manager_set_default_params 
    TODManager_SetParams {
        system = 1
        current_state = Afternoon
        transition_length = 90000
        groups = [
            {parts = 6 wait_frames = 3 light_group = outdoor}
            {parts = 2 wait_frames = 3 light_group = NoLevelLights reset_light_group = indoor}
        ]
        Morning = tod_manager_default_morning
        Afternoon = tod_manager_default_afternoon
        Evening = tod_manager_default_evening
        Night = tod_manager_default_night
    }
    TODManager_SetParams {
        sky
        system = 2
        current_state = Afternoon
        transition_length = 90000
        groups = [
            {parts = 6 wait_frames = 3 light_group = outdoor}
            {parts = 2 wait_frames = 3 light_group = NoLevelLights reset_light_group = indoor}
        ]
        Morning = tod_manager_default_morning_sky
        Afternoon = tod_manager_default_afternoon_sky
        Evening = tod_manager_default_evening_sky
        Night = tod_manager_default_night_sky
    }
endscript


script tod_manager_state_transition 
    GetCurrentLevel
    tod_manager_update_car_textures <...> 
    if StructureContains structure = tod_manager_levels_using_new_system <level>
        KillSpawnedScript name = tod_manager_instant_fakelights_and_geo
        KillSpawnedScript name = tod_manager_update_fakelights_and_geo
    else
        KillSpawnedScript name = tod_manager_update_fakelights
        KillSpawnedScript name = tod_manager_update_geo
    endif
    KillSpawnedScript name = tod_manager_update_car_textures
    if StructureContains structure = tod_manager_levels_using_new_system <level>
        if GotParam instant_change
            tod_manager_instant_fakelights_and_geo <...> 
        else
            tod_manager_update_fakelights_and_geo <...> 
        endif
    else
        tod_manager_update_fakelights <...> 
        tod_manager_update_geo <...> 
    endif
    if GotParam level_specific_transition_script
        <level_specific_transition_script> <...> 
    endif
    if GotParam set_inactive
        TODManager_SetActive 0
    endif
endscript


script tod_manager_update_fakelights_and_geo wait_time = 60
    tod_manager_get_tod_strings current_tod = <current_tod>
    <tod_struct> = (<tod_state_params>.<next_tod>)
    <headlights_on> = (<tod_struct>.headlights_on)
    if (<headlights_on> = 1)
        CarTOD_TurnOnHeadlights
    else
        CarTOD_TurnOffHeadlights
    endif
    <index> = 1
    begin 
    if (<index> < 10)
        FormatText textname = current_light_prefix 'TRG_%s_LevelLight_0%i' s = <current_tod_string> i = <index>
        FormatText textname = current_geo_on_prefix '%sOn_0%i' s = <current_tod_string> i = <index>
        FormatText textname = current_geo_off_prefix '%sOff_0%i' s = <current_tod_string> i = <index>
        FormatText textname = next_light_prefix 'TRG_%s_LevelLight_0%i' s = <next_tod_string> i = <index>
        FormatText textname = next_geo_on_prefix '%sOn_0%i' s = <next_tod_string> i = <index>
        FormatText textname = next_geo_off_prefix '%sOff_0%i' s = <next_tod_string> i = <index>
    else
        FormatText textname = current_light_prefix 'TRG_%s_LevelLight_%i' s = <current_tod_string> i = <index>
        FormatText textname = current_geo_on_prefix '%sOn_%i' s = <current_tod_string> i = <index>
        FormatText textname = current_geo_off_prefix '%sOff_%i' s = <current_tod_string> i = <index>
        FormatText textname = next_light_prefix 'TRG_%s_LevelLight_%i' s = <next_tod_string> i = <index>
        FormatText textname = next_geo_on_prefix '%sOn_%i' s = <next_tod_string> i = <index>
        FormatText textname = next_geo_off_prefix '%sOff_%i' s = <next_tod_string> i = <index>
    endif
    FakeLights percent = 0 time = <wait_time> prefix = <current_light_prefix> noprefixwarning
    wait (<wait_time> + 1)gameframe
    Kill prefix = <current_geo_on_prefix> noprefixwarning
    TODManager_Create prefix = <current_geo_off_prefix> noprefixwarning
    FakeLights percent = 100 time = <wait_time> prefix = <next_light_prefix> noprefixwarning
    wait (<wait_time> + 1)gameframe
    TODManager_Create prefix = <next_geo_on_prefix> noprefixwarning
    Kill prefix = <next_geo_off_prefix> noprefixwarning
    <index> = (<index> + 1)
    repeat tod_manager_num_prefixes
    UpdateFxLighting
    if (<next_tod> = Night)
        
        Kill prefix = 'TRG_SFX_TrigBox_Day' noprefixwarning
        Kill prefix = 'TRG_SFX_TrigBox_Night' noprefixwarning
        TODManager_Create prefix = 'TRG_SFX_TrigBox_Night' noprefixwarning
    else
        
        Kill prefix = 'TRG_SFX_TrigBox_Day' noprefixwarning
        Kill prefix = 'TRG_SFX_TrigBox_Night' noprefixwarning
        TODManager_Create prefix = 'TRG_SFX_TrigBox_Day' noprefixwarning
    endif
endscript


script tod_manager_get_tod_strings 
    switch <current_tod>
        case Morning
        return current_tod_string = 'morning' next_tod_string = 'afternoon'
        case Afternoon
        return current_tod_string = 'afternoon' next_tod_string = 'evening'
        case Evening
        return current_tod_string = 'evening' next_tod_string = 'night'
        case Night
        return current_tod_string = 'night' next_tod_string = 'morning'
        default 
        script_assert 'Unrecognized tod state'
    endswitch
endscript


script tod_manager_instant_fakelights_and_geo 
    tod_manager_get_tod_strings current_tod = <current_tod>
    FormatText textname = next_light_prefix 'TRG_%s_LevelLight' s = <next_tod_string>
    FormatText textname = next_geo_on_prefix '%sOn' s = <next_tod_string>
    FormatText textname = next_geo_off_prefix '%sOff' s = <next_tod_string>
    tod_state_names = [
        'morning'
        'afternoon'
        'evening'
        'night'
    ]
    GetArraySize <tod_state_names>
    <index> = 0
    begin 
    if ((<tod_state_names> [ <index> ])= <next_tod_string>)
        FormatText textname = light_prefix 'TRG_%s_LevelLight' s = (<tod_state_names> [ <index> ])
        FormatText textname = geo_on_prefix '%sOn' s = (<tod_state_names> [ <index> ])
        FakeLights percent = 0 time = 0 prefix = <light_prefix> noprefixwarning
        wait 1 gameframe
        Kill prefix = <geo_on_prefix> noprefixwarning
    endif
    <index> = (<index> + 1)
    repeat <array_size>
    if GotParam temp_state
        next_tod_string = 'temp_state'
    else
        FakeLights percent = 100 time = 0 prefix = <next_light_prefix> noprefixwarning
        wait 1 gameframe
        TODManager_Create prefix = <next_geo_on_prefix> noprefixwarning
        Kill prefix = <next_geo_off_prefix> noprefixwarning
    endif
    <index> = 0
    begin 
    if NOT ((<tod_state_names> [ <index> ])= <next_tod_string>)
        FormatText textname = light_prefix 'TRG_%s_LevelLight' s = (<tod_state_names> [ <index> ])
        FormatText textname = geo_on_prefix '%sOn' s = (<tod_state_names> [ <index> ])
        FormatText textname = geo_off_prefix '%sOff' s = (<tod_state_names> [ <index> ])
        FakeLights percent = 0 time = 0 prefix = <light_prefix> noprefixwarning
        wait 1 gameframe
        Kill prefix = <geo_on_prefix> noprefixwarning
        TODManager_Create prefix = <geo_off_prefix> noprefixwarning
    endif
    <index> = (<index> + 1)
    repeat <array_size>
    UpdateFxLighting
    if (<next_tod> = Night)
        Kill prefix = 'TRG_SFX_TrigBox_Day' noprefixwarning
        Kill prefix = 'TRG_SFX_TrigBox_Night' noprefixwarning
        TODManager_Create prefix = 'TRG_SFX_TrigBox_Night' noprefixwarning
    else
        Kill prefix = 'TRG_SFX_TrigBox_Day' noprefixwarning
        Kill prefix = 'TRG_SFX_TrigBox_Night' noprefixwarning
        TODManager_Create prefix = 'TRG_SFX_TrigBox_Day' noprefixwarning
    endif
    <tod_struct> = (<tod_state_params>.<next_tod>)
    <headlights_on> = (<tod_struct>.headlights_on)
    if (<headlights_on> = 1)
        CarTOD_TurnOnHeadlights
    else
        CarTOD_TurnOffHeadlights
    endif
endscript


script tod_manager_update_fakelights wait_time = 120
    switch <current_tod>
        case Morning
        current_prefixes = tod_afternoon_light_prefixes
        old_prefixes = tod_morning_light_prefixes
        case Afternoon
        current_prefixes = tod_evening_light_prefixes
        old_prefixes = tod_afternoon_light_prefixes
        case Evening
        current_prefixes = tod_night_light_prefixes
        old_prefixes = tod_evening_light_prefixes
        case Night
        current_prefixes = tod_morning_light_prefixes
        old_prefixes = tod_night_light_prefixes
        default 
        script_assert 'Unrecognized tod state'
    endswitch
    GetArraySize <old_prefixes>
    <index> = 0
    begin 
    FakeLights percent = 0 time = <wait_time> prefix = (<old_prefixes> [ <index> ])noprefixwarning
    wait (<wait_time> + 1)gameframe
    <index> = (<index> + 1)
    repeat <array_size>
    GetArraySize <current_prefixes>
    <index> = 0
    begin 
    FakeLights percent = 100 time = <wait_time> prefix = (<current_prefixes> [ <index> ])noprefixwarning
    wait (<wait_time> + 1)gameframe
    <index> = (<index> + 1)
    repeat <array_size>
    <tod_struct> = (<tod_state_params>.<next_tod>)
    <headlights_on> = (<tod_struct>.headlights_on)
    if (<headlights_on> = 1)
        CarTOD_TurnOnHeadlights
    else
        CarTOD_TurnOffHeadlights
    endif
    UpdateFxLighting
endscript


script tod_manager_update_car_textures 
    switch <next_tod>
        case Morning
        ReplaceCarTextures {
            array = [
                {
                    src = 'JKU_LightCircle_Transparent.png' dest = 'textures/cars/JKU_LightCircle_Transparent'
                }
                {
                    src = 'JKU_HeadlightGlow_Transparent.png' dest = 'textures/cars/JKU_HeadlightGlow'
                }
            ]
        }
        case Afternoon
        ReplaceCarTextures {
            array = [
                {
                    src = 'JKU_LightCircle_Transparent.png' dest = 'textures/cars/JKU_LightCircle_Transparent'
                }
                {
                    src = 'JKU_HeadlightGlow_Transparent.png' dest = 'textures/cars/JKU_HeadlightGlow_Transparent'
                }
            ]
        }
        case Evening
        ReplaceCarTextures {
            array = [
                {
                    src = 'JKU_LightCircle_Transparent.png' dest = 'textures/cars/JKU_LightCircle_Transparent'
                }
                {
                    src = 'JKU_HeadlightGlow_Transparent.png' dest = 'textures/cars/JKU_HeadlightGlow'
                }
            ]
        }
        case Night
        ReplaceCarTextures {
            array = [
                {
                    src = 'JKU_LightCircle_Transparent.png' dest = 'textures/cars/JKU_LightCircle'
                }
                {
                    src = 'JKU_HeadlightGlow_Transparent.png' dest = 'textures/cars/JKU_HeadlightGlow'
                }
            ]
        }
        default 
        
    endswitch
endscript


script tod_manager_update_geo 
    switch <next_tod>
        case Morning
        TODManager_Create prefix = 'MorningOn' noprefixwarning
        TODManager_Create prefix = 'AfternoonOff' noprefixwarning
        TODManager_Create prefix = 'EveningOff' noprefixwarning
        TODManager_Create prefix = 'NightOff' noprefixwarning
        Kill prefix = 'MorningOff' noprefixwarning
        Kill prefix = 'AfternoonOn' noprefixwarning
        Kill prefix = 'EveningOn' noprefixwarning
        Kill prefix = 'NightOn' noprefixwarning
        case Afternoon
        TODManager_Create prefix = 'MorningOff' noprefixwarning
        TODManager_Create prefix = 'EveningOff' noprefixwarning
        TODManager_Create prefix = 'NightOff' noprefixwarning
        TODManager_Create prefix = 'AfternoonOn' noprefixwarning
        Kill prefix = 'AfternoonOff' noprefixwarning
        Kill prefix = 'MorningOn' noprefixwarning
        Kill prefix = 'EveningOn' noprefixwarning
        Kill prefix = 'NightOn' noprefixwarning
        case Evening
        TODManager_Create prefix = 'MorningOff' noprefixwarning
        TODManager_Create prefix = 'AfternoonOff' noprefixwarning
        TODManager_Create prefix = 'NightOff' noprefixwarning
        TODManager_Create prefix = 'EveningOn' noprefixwarning
        Kill prefix = 'EveningOff' noprefixwarning
        Kill prefix = 'AfternoonOn' noprefixwarning
        Kill prefix = 'MorningOn' noprefixwarning
        Kill prefix = 'NightOn' noprefixwarning
        case Night
        TODManager_Create prefix = 'MorningOff' noprefixwarning
        TODManager_Create prefix = 'DefaultOff' noprefixwarning
        TODManager_Create prefix = 'EveningOff' noprefixwarning
        TODManager_Create prefix = 'NightOn' noprefixwarning
        Kill prefix = 'NightOff' noprefixwarning
        Kill prefix = 'DefaultOn' noprefixwarning
        Kill prefix = 'MorningOn' noprefixwarning
        Kill prefix = 'EveningOn' noprefixwarning
        default 
        
    endswitch
    if (<next_tod> = Night)
        
        Kill prefix = 'TRG_SFX_TrigBox_Day'
        Kill prefix = 'TRG_SFX_TrigBox_Night'
        TODManager_Create prefix = 'TRG_SFX_TrigBox_Night'
    else
        
        Kill prefix = 'TRG_SFX_TrigBox_Night'
        TODManager_Create prefix = 'TRG_SFX_TrigBox_Day'
    endif
endscript

